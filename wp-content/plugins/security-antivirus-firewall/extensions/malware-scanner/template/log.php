<?php
/*  
 * Security Antivirus Firewall (wpTools S.A.F.)
 * http://wptools.co/wordpress-security-antivirus-firewall
 * Version:           	2.1.23
 * Build:             	34569
 * Author:            	WpTools
 * Author URI:        	http://wptools.co
 * License:           	License: GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
 * Date:              	Tue, 17 Jan 2017 18:05:12 GMT
 */

if ( ! defined( 'WPINC' ) )  die;
if ( ! defined( 'ABSPATH' ) ) exit;

$id = 'detail-log-' . mt_rand();

$fileStatuses 	= wptsafExtensionMalwareScannerLog::getFileStatuses();
$scanModes 		= wptsafExtensionMalwareScannerLog::getScanModes();
$scanStatuses 	= wptsafExtensionMalwareScannerLog::getScanStatuses();

?>
<div class="row">
	<div class="col-md-12 col-xs-12">
		<div class="x_panel">
			<div class="x_title">
				<h2><?php echo $extensionTitle . ': ' . __('Detailed log', 'wptsaf_security'); ?></h2>
				<div class="clearfix"></div>
			</div>
			<div class="x_content">
				<?php if ($limitMessage) : ?>
					<div class="limit-message alert alert-warning">
						<?php echo $limitMessage; ?>
					</div>
				<?php endif; ?>
				
				<div class="wrapper-log">
					<table id="<?php echo $id; ?>" class="log table table-striped table-bordered">
						<thead>
						<tr>
							<?php foreach ($header as $title) : ?>
								<th>
									<?php echo __($title, 'wptsaf_security'); ?>
								</th>
							<?php endforeach; ?>
							<th><?php _e('Actions', 'wptsaf_security'); ?></th>
						</tr>
						</thead>
						<tbody>
						<?php $columns = array_keys($header); ?>
						<?php foreach ($rows as $row) : ?>
							<tr>
								<?php foreach ($columns as $column) : ?>
									<td>
										<?php
											if ('status' == $column) {
												echo $fileStatuses[$row[$column]];
											} elseif ('scan_mode' == $column) {
												echo $row[$column] ? $scanModes[$row[$column]] : '';
											} elseif ('scan_status' == $column) {
												echo $scanStatuses[$row[$column]];
											} else {
												echo $row[$column];
											}
										?>
									</td>
								<?php endforeach; ?>
								<td><?php echo $row['id']; ?>|<?php echo $row['scan_resource']; ?></td>
							</tr>
						<?php endforeach; ?>
						</tbody>
					</table>
				</div>
				<div class="clear"></div>
				
				<div class="ln_solid"></div>
				<div class="buttons">
					<button class="btn btn-default pull-right btn-popup-close">
						<?php _e('Close', 'wptsaf_security'); ?>
					</button>
				</div>
			</div>
		</div>
	</div>
</div>

<script>
	(function ($) {
		var statuses = <?php echo json_encode(wptsafExtensionMalwareScannerLog::getFileStatuses()); ?>;
		var scanModes = <?php echo json_encode(wptsafExtensionMalwareScannerLog::getScanModes()); ?>;
		var scanStatuses = <?php echo json_encode(wptsafExtensionMalwareScannerLog::getScanStatuses()); ?>;
		var buttons = [];

		<?php if (!$isFiltered) : ?>
			buttons = [
				{
					text: 'Download log',
					action: function () {
						window.open(wptsafSecurity.ajaxUrl + '?action=wptsaf_security&extension=malware-scanner&method=logExport&nonce=' + wptsafSecurity.ajaxNonce,'_blank');
					}
				},
				{
					text: 'Clear log',
					action: function () {
						wptsafDataAction.processAction(null, 'action=wptsaf_security&extension=malware-scanner&method=logAskClear', null, false);
					}
				}
			];
		<?php endif; ?>

		var $dataTableLog = $('#<?php echo $id; ?>').dataTable({
			sDom: '<"top"<"dataTables_group_block"B><"dataTables_group_block"lp>>rt<"bottom"ip>',
			"pageLength": 50,
			"lengthMenu": [50, 100, 200],
			ordering: false,
			searching: true,
			responsive: true,
			buttons: buttons,
			columns: [
				{
					data: 'date_gmt'
				},
				{
					data: 'file'
				},
				{
					data: 'status'
				},
				{
					data: 'scan_status'
				},
				{
					data: 'scan_date_gmt'
				},
				{
					data: 'actions',
					render: function (data, type, row ) {
						var pieces = data.split('|'),
							id = pieces[0],
							scanResource = pieces[1],
							linkScanReport = '';

						if ('infected' == row.status) {
							linkScanReport = '<br /><a href="https://www.virustotal.com/en/file/' + scanResource + '/analysis/" target="_blank" class="btn btn-info btn-xs"><?php _e('Scan report'); ?></a>'
						}

						/*return '<button class="btn btn-info btn-xs"'
							+ 'data-action="action=wptsaf_security&extension=malware-scanner&'
							+ 'method=logRow&args[id]=' + id + '"'
							+ '>'
							+ '<?php _e('Detail', 'wptsaf_security'); ?>'
							+ '</button>'
							+ linkScanReport;*/
						return	linkScanReport;
					}
				}
			],
			initComplete: function () {
				var $this = $(this),
					$selectStatus = $('<select class="status"></select>'),
					$selectScanModes = $('<select class="scan_mode"></select>');
					$selectScanStatus = $('<select class="scan_status"></select>');

				$selectStatus.append('<option value=""><?php _e('All', 'wptsaf_security'); ?></option>');
				$.each(statuses, function (value, label) {
					$selectStatus.append('<option value="' + label + '">' + label + '</option>');
				});

				$selectScanModes.append('<option value=""><?php _e('All', 'wptsaf_security'); ?></option>');
				$selectScanModes.append('<option value="null"><?php _e('empty mode', 'wptsaf_security'); ?></option>');
				$.each(scanModes, function (value, label) {
					$selectScanModes.append('<option value="' + label + '">' + label + '</option>');
				});

				$selectScanStatus.append('<option value=""><?php _e('All', 'wptsaf_security'); ?></option>');
				$.each(scanStatuses, function (value, label) {
					$selectScanStatus.append('<option value="' + label + '">' + label + '</option>');
				});

				var $tr = $('<tr>');
				$tr.append('<th></th>'); // date_gmt
				$tr.append('<th></th>'); // file
				$tr.append($('<th></th>').append($selectStatus));
				//$tr.append($('<th></th>').append($selectScanModes));
				$tr.append($('<th></th>').append($selectScanStatus));
				$tr.append('<th>'); // scan_date_gmt
				$tr.append('<th>'); // actions
				$this.find('thead').append($tr);

				$this.on('change', 'select.status', function () {
					var $this = $(this),
						val = $this.val();

					$dataTableLog.dataTable().api().columns(2).search(
						val ? '^' + val + '$' : '',
						val ? true : false,
						false
					).draw();
				});
				$this.on('change', 'select.scan_mode', function () {
					var $this = $(this),
						val = $this.val();

					if ('null' == val) {
						$dataTableLog.dataTable().api().columns(3).search('^$', true, false).draw();
					} else {
						$dataTableLog.dataTable().api().columns(3).search($this.val(), true, false).draw();
					}
				});
				$this.on('change', 'select.scan_status', function () {
					var $this = $(this);
					$dataTableLog.dataTable().api().columns(4).search($this.val(), false, false).draw();
				});
			}
		});
	})(jQuery);
</script>

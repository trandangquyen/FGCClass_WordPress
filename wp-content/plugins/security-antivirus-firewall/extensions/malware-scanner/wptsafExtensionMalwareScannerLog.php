<?php
/*  
 * Security Antivirus Firewall (wpTools S.A.F.)
 * http://wptools.co/wordpress-security-antivirus-firewall
 * Version:           	2.1.23
 * Build:             	34569
 * Author:            	WpTools
 * Author URI:        	http://wptools.co
 * License:           	License: GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html
 * Date:              	Tue, 17 Jan 2017 18:05:12 GMT
 */

if ( ! defined( 'WPINC' ) )  die;
if ( ! defined( 'ABSPATH' ) ) exit;

class wptsafExtensionMalwareScannerLog extends wptsafAbstractLog{

	protected static $fileStatuses;

	protected static $scanModes;

	protected static $scanStatuses;

	public function __construct(wptsafAbstractExtension $extension){
		parent::__construct($extension);

		$this->table = WPTSAF_DB_PREFIX . 'malware_scanner_log';
		$this->fieldList = array(
			'file',
			'status',
			'date_gmt',
			'scan_resource',
			'scan_mode',
			'scan_status',
			'scan_date_gmt'
		);

		self::$fileStatuses = array(
			wptsafExtensionMalwareScannerScanner::FILE_STATUS_PENDING => __('pending', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::FILE_STATUS_CHECKED => __('checked', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::FILE_STATUS_PROBABLY_INFECTED => __('probably infected', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::FILE_STATUS_INFECTED => __('infected', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::FILE_STATUS_NOT_EXISTS => __('not exists', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::FILE_STATUS_TOO_LARGE => __('too large', 'wptsaf_security')
		);

		self::$scanModes = array(
			wptsafExtensionMalwareScannerScanner::SCAN_MODE_ARCHIVE => __('archive', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::SCAN_MODE_FILE => __('file', 'wptsaf_security'),
		);
		
		self::$scanStatuses = array(
			wptsafExtensionMalwareScannerScanner::SCAN_STATUS_PENDING => __('pending', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::SCAN_STATUS_PACKING => __('packing', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::SCAN_STATUS_SCANNING => __('scanning', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::SCAN_STATUS_SCANNED => __('scanned', 'wptsaf_security'),
			wptsafExtensionMalwareScannerScanner::SCAN_STATUS_PASS => __('pass', 'wptsaf_security')
		);
	}

	public static function getFileStatuses(){
		return self::$fileStatuses;
	}

	public static function getScanModes(){
		return self::$scanModes;
	}

	public static function getScanStatuses(){
		return self::$scanStatuses;
	}

	public function addFiles(array $files){
		$now = wptsafEnv::getInstance()->getDateGmt();
		$rows = array();

		foreach ($files as $file) {
			$rows[] = array(
				'file' => $file,
				'date_gmt' => $now,
				'status' => wptsafExtensionMalwareScannerScanner::FILE_STATUS_PENDING,
				'scan_status' => wptsafExtensionMalwareScannerScanner::SCAN_STATUS_PENDING
			);
		}

		$this->insertRows($rows);
	}


	public function getStatusState(array $where = array()){
		global $wpdb;
		$statuses = "'" . implode("', '", array_keys(self::$fileStatuses)) . "'";
		$whereParams = $this->prepareWhereParams($where);

		if (is_wp_error($whereParams)) {
			return $whereParams;
		}
		return $wpdb->get_results(
			"SELECT status, count(*) as count
			FROM `{$this->table}`
			{$whereParams}
			GROUP BY status
			ORDER BY FIELD(status, {$statuses}) ASC",
			ARRAY_A
		);
	}


	public function getScanStatusState(){
		global $wpdb;
		$statuses = "'" . implode("', '", array_keys(self::$scanStatuses)) . "'";
		return $wpdb->get_results(
			"SELECT scan_status, count(*) as count
			FROM `{$this->table}`
			GROUP BY scan_status
			ORDER BY FIELD(scan_status, {$statuses}) ASC",
			ARRAY_A
		);
	}

	public function prepareRow(array $row){
		$row = parent::prepareRow($row);
		$row['scan_date_gmt'] = $row['scan_date_gmt']
			? date(WPTSAF_DATE_FORMAT, $row['scan_date_gmt'] + WPTSAF_DATE_GMT_OFFSET)
			: '';
		return $row;
	}

	public function getRows($limit = 10, $offset = 0, $order = 'DESC', $orderBy = null, array $where = array()){
		if (!$orderBy) {
			$orderBy = sprintf(
				"date_gmt %s, FIELD(status, '%s', '%s', '%s', '%s')",
				$order,
				wptsafExtensionMalwareScannerScanner::FILE_STATUS_INFECTED,
				wptsafExtensionMalwareScannerScanner::FILE_STATUS_PROBABLY_INFECTED,
				wptsafExtensionMalwareScannerScanner::FILE_STATUS_PENDING,
				wptsafExtensionMalwareScannerScanner::FILE_STATUS_CHECKED
			);
			$order = 'ASC';
		}
		return parent::getRows($limit, $offset, $order, $orderBy, $where);
	}

	public function createTable(){
		global $wpdb;
		$wpdb->query(
			"CREATE TABLE  IF NOT EXISTS `{$this->table}` (
				 `id` int(11) NOT NULL AUTO_INCREMENT,
				 `file` varchar(500) NOT NULL,
				 `status` varchar(20) NOT NULL,
				 `date_gmt` int(11) NOT NULL,
				 `scan_resource` varchar(100) DEFAULT NULL,
				 `scan_mode` varchar(10) DEFAULT NULL,
				 `scan_status` varchar(10) NOT NULL,
				 `scan_date_gmt` int(11) DEFAULT NULL,
				 PRIMARY KEY (`id`),
				 KEY `status` (`status`),
				 KEY `scan_resource` (`scan_resource`),
				 KEY `scan_status` (`scan_status`)
			)
			DEFAULT CHARACTER SET utf8
  			DEFAULT COLLATE utf8_general_ci"
		);
	}
}
